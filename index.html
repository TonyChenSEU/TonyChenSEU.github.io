<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>DRM 演示</title>
    <!-- 引入 dash.js 和 hls.js -->
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
<div style="margin: 20px;">
    <h3>WISEPLAY player</h3>
    <video id="wiseplayPlayer" controls width="800"></video>
</div>
<div style="margin: 20px;">
    <h3>WIDEVINE player</h3>
    <video id="widevinePlayer" controls width="800"></video>
</div>


<div style="margin: 20px;">
    <h3>PLAYREADY player</h3>
    <video id="playreadyPlayer" controls width="800"></video>
</div>

<script>
    // 公共配置
    const WISEPLAY_KEY_SYSTEM = 'com.wiseplay.drmy';
    const WIDEVINE_KEY_SYSTEM = 'com.widevine.alpha';
    const PLAYREADY_KEY_SYSTEM = 'com.microsoft.playready';
    const WISEPLAY_LICENSE_URL = 'http://license.dev.trustdta.com:8080/drmproxy/v3/getLicense?contentId=34Z29nq6eW9j4eu&useDrmProxy=1';
    const WIDEVINE_LICENSE_URL = 'https://cwip-shaka-proxy.appspot.com/no_auth';
    const PLAYREADY_LICENSE_URL = 'https://test.playready.microsoft.com/service/rightsmanager.asmx?PlayRight=1&ContentKey=EAtsIJQPd5pFiRUrV9Layw==';

    // 初始化 HLS 播放器
    async function initializeWiseplayPlayer() {
        const videoElement = document.getElementById('wiseplayPlayer');

        try {
            // 请求 MediaKeySystemAccess
            // const access = await navigator.requestMediaKeySystemAccess(WISEPLAY_KEY_SYSTEM, [{
            //     initDataTypes: ['cenc'],
            //     videoCapabilities: [{
            //         contentType: 'video/mp4;codecs="avc1.42c01f"'
            //     }]
            // }]);
            const access = await navigator.requestMediaKeySystemAccess(WISEPLAY_KEY_SYSTEM, [{
                initDataTypes: ['cenc'],
                videoCapabilities: [{
                    contentType: 'video/mp4;codecs="avc1.42c01f"'
                }]
            }]);

            // 创建 MediaKeys
            const mediaKeys = await access.createMediaKeys();
            await videoElement.setMediaKeys(mediaKeys);

            // 初始化 hls.js
            const hls = new Hls({
                emeEnabled: true,
                drmSystemOptions: {
                    [WISEPLAY_KEY_SYSTEM]: {
                        licenseUrl: WISEPLAY_LICENSE_URL
                    }
                }
            });

            hls.loadSource('https://cdn.bitmovin.com/content/assets/art-of-motion_drm/m3u8s/11331.m3u8');
            hls.attachMedia(videoElement);

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                videoElement.play();
            });
        } catch (error) {
            console.error('wiseplay fail:', error);
        }
    }

    // 初始化 DASH 播放器
    async function initializeWidevinePlayer() {
        const videoElement = document.getElementById('widevinePlayer');

        try {
            // 请求 MediaKeySystemAccess
            const access = await navigator.requestMediaKeySystemAccess(WIDEVINE_KEY_SYSTEM, [{
                initDataTypes: ['cenc'],
                videoCapabilities: [{
                    contentType: 'video/mp4;codecs="avc1.42c01f"'
                }]
            }]);
            // 初始化 hls.js
            const hls = new Hls({
                emeEnabled: true,
                drmSystemOptions: {
                    [WISEPLAY_KEY_SYSTEM]: {
                        licenseUrl: PLAYREADY_LICENSE_URL
                    }
                }
            });

            hls.loadSource('https://cdn.bitmovin.com/content/assets/art-of-motion_drm/m3u8s/11331.m3u8');
            hls.attachMedia(videoElement);

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                videoElement.play();
            });


            // // 创建 MediaKeys
            // const mediaKeys = await access.createMediaKeys();
            // await videoElement.setMediaKeys(mediaKeys);
            //
            // // 初始化 dash.js
            // const player = dashjs.MediaPlayer().create();
            // player.initialize(videoElement, 'https://cdn.bitmovin.com/content/assets/art-of-motion_drm/mpds/11331.mpd', true);
            //
            // // 配置 DRM
            // player.setProtectionData({
            //     [WISEPLAY_KEY_SYSTEM]: {
            //         serverURL: WIDEVINE_LICENSE_URL
            //     }
            // });
        } catch (error) {
            console.error('widevine fail:', error);
        }
    }



    // 初始化 HLS 播放器
    async function initializePlayreadyPlayer() {
        const videoElement = document.getElementById('playreadyPlayer');

        try {
            // 请求 MediaKeySystemAccess
            // const access = await navigator.requestMediaKeySystemAccess(WISEPLAY_KEY_SYSTEM, [{
            //     initDataTypes: ['cenc'],
            //     videoCapabilities: [{
            //         contentType: 'video/mp4;codecs="avc1.42c01f"'
            //     }]
            // }]);
            const access = await navigator.requestMediaKeySystemAccess(PLAYREADY_KEY_SYSTEM, [{
                initDataTypes: ['cenc'],
                videoCapabilities: [{
                    contentType: 'video/mp4;codecs="avc1.42c01f"'
                }]
            }]);

            // 创建 MediaKeys
            const mediaKeys = await access.createMediaKeys();
            await videoElement.setMediaKeys(mediaKeys);

            // 初始化 hls.js
            const hls = new Hls({
                emeEnabled: true,
                drmSystemOptions: {
                    [WISEPLAY_KEY_SYSTEM]: {
                        licenseUrl: PLAYREADY_LICENSE_URL
                    }
                }
            });

            hls.loadSource('https://cdn.bitmovin.com/content/assets/art-of-motion_drm/m3u8s/11331.m3u8');
            hls.attachMedia(videoElement);

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                videoElement.play();
            });
        } catch (error) {
            console.error('playready fail:', error);
        }
    }

    // 页面加载完成后初始化播放器
    window.addEventListener('DOMContentLoaded', () => {
        initializeWiseplayPlayer();
        initializeWidevinePlayer();
        initializePlayreadyPlayer();
    });
</script>
</body>
</html>